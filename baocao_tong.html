<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Báo Cáo Sản Xuất</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-center">Báo Cáo Sản Xuất</h1>
            <p class="text-center text-blue-100 mt-2">Dashboard Theo Dõi Hoạt Động Sản Xuất</p>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white shadow-sm border-b sticky top-0 z-10">
        <div class="container mx-auto px-4">
            <nav class="flex overflow-x-auto scrollbar-hide space-x-2 lg:space-x-8 pb-0">
                <button onclick="showReport('may3d')"
                    class="tab-btn active py-3 px-4 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap flex-shrink-0">
                    <i class="fas fa-cogs mr-2"></i>Máy Đo 3D
                </button>
                <button onclick="showReport('sanluong')"
                    class="tab-btn py-3 px-4 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 whitespace-nowrap flex-shrink-0">
                    <i class="fas fa-chart-bar mr-2"></i>Sản Lượng Nhóm
                </button>
                <button onclick="showReport('loi')"
                    class="tab-btn py-3 px-4 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 whitespace-nowrap flex-shrink-0">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Lỗi Phát Sinh
                </button>
                <button onclick="showReport('danhbong')"
                    class="tab-btn py-3 px-4 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 whitespace-nowrap flex-shrink-0">
                    <i class="fas fa-gem mr-2"></i>Đánh Bóng
                </button>
                <button onclick="showReport('hangnhan')"
                    class="tab-btn py-3 px-4 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 whitespace-nowrap flex-shrink-0">
                    <i class="fas fa-truck-loading mr-2"></i>Hàng Nhận
                </button>
                <button onclick="showReport('hanggiao')"
                    class="tab-btn py-3 px-4 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 whitespace-nowrap flex-shrink-0">
                    <i class="fas fa-shipping-fast mr-2"></i>Hàng Giao
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6">
        <!-- Báo cáo Máy Đo 3D -->
        <div id="may3d" class="report-section">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-cogs text-blue-600 mr-3"></i>
                        Báo Cáo Tình Trạng Hoạt Động Máy Đo 3D
                    </h2>
                    <button onclick="refreshAllData()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-sync mr-2"></i>Làm mới
                    </button>
                </div>

                <!-- Filters -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Bộ lọc dữ liệu</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                            <input type="date" id="dateFrom3d" onchange="applyFilter3D()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                            <input type="date" id="dateTo3d" onchange="applyFilter3D()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Số Máy</label>
                            <select id="machine3d" onchange="applyFilter3D()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Tất cả máy</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ca Làm Việc</label>
                            <select id="shift3d" onchange="applyFilter3D()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Tất cả ca</option>
                                <option value="1">Ca 1 (6h-14h)</option>
                                <option value="2">Ca 2 (14h-22h)</option>
                                <option value="3">Ca 3 (22h-6h)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="resetFilter3D()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-undo mr-2"></i>Đặt lại
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="text-blue-800 font-semibold">Tổng thời gian</h4>
                        <p class="text-2xl font-bold text-blue-600" id="totalTime3d">0h</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="text-green-800 font-semibold">Thời gian gia công</h4>
                        <p class="text-2xl font-bold text-green-600" id="workingTime3d">0h</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg">
                        <h4 class="text-red-800 font-semibold">Thời gian tạm dừng</h4>
                        <p class="text-2xl font-bold text-red-600" id="downTime3d">0h</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg">
                        <h4 class="text-yellow-800 font-semibold">Hiệu suất</h4>
                        <p class="text-2xl font-bold text-yellow-600" id="efficiency3d">0%</p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white border rounded-lg p-4">
                    <h4 class="text-lg font-semibold mb-4">Biểu đồ phân bổ thời gian theo máy (%)</h4>
                    <div class="h-96">
                        <canvas id="chart3d"></canvas>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-4">Chi tiết dữ liệu</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Máy</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chuẩn bị
                                        (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chạy thử
                                        (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gia công
                                        (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gá lắp
                                        (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tạm dừng
                                        (%)</th>
                                </tr>
                            </thead>
                            <tbody id="table3d" class="divide-y divide-gray-200">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Báo cáo Sản Lượng Nhóm -->
        <div id="sanluong" class="report-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-chart-bar text-green-600 mr-3"></i>
                        Báo Cáo Sản Lượng Các Nhóm
                    </h2>
                </div>

                <!-- Filters -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Bộ lọc dữ liệu</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                            <input type="date" id="dateFromSL" onchange="applyFilterSL()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                            <input type="date" id="dateToSL" onchange="applyFilterSL()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nhóm</label>
                            <select id="groupSL" onchange="applyFilterSL()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Tất cả nhóm</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tổ</label>
                            <select id="teamSL" onchange="applyFilterSL()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Tất cả tổ</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="resetFilterSL()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-undo mr-2"></i>Đặt lại
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="text-blue-800 font-semibold">Tổng sản lượng</h4>
                        <p class="text-2xl font-bold text-blue-600" id="totalProductionSL">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="text-green-800 font-semibold">Hiệu suất TB</h4>
                        <p class="text-2xl font-bold text-green-600" id="avgEfficiencySL">0%</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h4 class="text-purple-800 font-semibold">Tổng nhân sự</h4>
                        <p class="text-2xl font-bold text-purple-600" id="totalWorkersSL">0</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-lg font-semibold mb-4">So sánh thời gian thực tế vs lý thuyết</h4>
                        <div class="h-80">
                            <canvas id="chartSL"></canvas>
                        </div>
                    </div>
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-lg font-semibold mb-4">Phân bổ sản lượng theo nhóm</h4>
                        <div class="h-80">
                            <canvas id="chartSLPie"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-4">Chi tiết dữ liệu sản lượng</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nhóm
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã CV
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SL thực
                                        tế</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thời
                                        gian thực tế</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thời
                                        gian lý thuyết</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hiệu
                                        suất</th>
                                </tr>
                            </thead>
                            <tbody id="tableSL" class="divide-y divide-gray-200">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Báo cáo Lỗi Phát Sinh -->
        <div id="loi" class="report-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                        Báo Cáo Lỗi Phát Sinh
                    </h2>
                </div>

                <!-- Filters -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Bộ lọc dữ liệu</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                            <input type="date" id="dateFromLoi" onchange="applyFilterLoi()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                            <input type="date" id="dateToLoi" onchange="applyFilterLoi()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vị Trí Phát Sinh</label>
                            <select id="positionLoi" onchange="applyFilterLoi()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Tất cả vị trí</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="resetFilterLoi()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-undo mr-2"></i>Đặt lại
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-red-100 p-4 rounded-lg">
                        <h4 class="text-red-800 font-semibold">Tổng lỗi</h4>
                        <p class="text-2xl font-bold text-red-600" id="totalErrorsLoi">0</p>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-lg">
                        <h4 class="text-orange-800 font-semibold">Lỗi hôm nay</h4>
                        <p class="text-2xl font-bold text-orange-600" id="todayErrorsLoi">0</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg">
                        <h4 class="text-yellow-800 font-semibold">Vị trí nhiều lỗi nhất</h4>
                        <p class="text-lg font-bold text-yellow-600" id="topErrorPositionLoi">-</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h4 class="text-purple-800 font-semibold">Tỷ lệ lỗi TB</h4>
                        <p class="text-2xl font-bold text-purple-600" id="avgErrorRateLoi">0%</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-lg font-semibold mb-4">Phân bổ lỗi theo vị trí</h4>
                        <div class="h-80">
                            <canvas id="chartLoiPie"></canvas>
                        </div>
                    </div>
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-lg font-semibold mb-4">Xu hướng lỗi theo thời gian</h4>
                        <div class="h-80">
                            <canvas id="chartLoiLine"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Errors Table -->
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-4">Top 10 mã lỗi phát sinh nhiều nhất</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã lỗi
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số lần
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vị trí
                                        phát sinh</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nơi xử
                                        lý</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tỷ lệ
                                        (%)</th>
                                </tr>
                            </thead>
                            <tbody id="tableLoi" class="divide-y divide-gray-200">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Báo cáo Đánh Bóng -->
        <div id="danhbong" class="report-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-gem text-purple-600 mr-3"></i>
                        Báo Cáo Hoàn Thiện Đánh Bóng
                    </h2>
                </div>

                <!-- Filters -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Bộ lọc dữ liệu</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                            <input type="date" id="dateFromDB" onchange="applyFilterDB()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                            <input type="date" id="dateToDB" onchange="applyFilterDB()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="resetFilterDB()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-undo mr-2"></i>Đặt lại
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h4 class="text-purple-800 font-semibold">Tổng sản lượng</h4>
                        <p class="text-2xl font-bold text-purple-600" id="totalProductionDB">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="text-blue-800 font-semibold">Thời gian TB</h4>
                        <p class="text-2xl font-bold text-blue-600" id="avgTimeDB">0h</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="text-green-800 font-semibold">Hiệu suất</h4>
                        <p class="text-2xl font-bold text-green-600" id="efficiencyDB">0%</p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold mb-4">Xu hướng sản lượng đánh bóng theo thời gian</h4>
                    <div class="h-96">
                        <canvas id="chartDB"></canvas>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-4">Chi tiết hoàn thiện đánh bóng</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ngày
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã CV
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên chi
                                        tiết</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SL thực
                                        tế</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thời
                                        gian thực tế</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hiệu
                                        suất (%)</th>
                                </tr>
                            </thead>
                            <tbody id="tableDB" class="divide-y divide-gray-200">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Báo cáo Hàng Nhận -->
        <div id="hangnhan" class="report-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-truck-loading text-green-600 mr-3"></i>
                        Tổng Hợp Số Lượng Hàng Nhận
                    </h2>
                </div>

                <!-- Filters -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Bộ lọc dữ liệu</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                            <input type="date" id="dateFromHN" onchange="applyFilterHN()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                            <input type="date" id="dateToHN" onchange="applyFilterHN()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loại thống kê</label>
                            <select id="periodHN" onchange="applyFilterHN()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="daily">Theo ngày</option>
                                <option value="weekly">Theo tuần</option>
                                <option value="monthly">Theo tháng</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="resetFilterHN()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-undo mr-2"></i>Đặt lại
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="text-green-800 font-semibold">Tổng hàng nhận</h4>
                        <p class="text-2xl font-bold text-green-600" id="totalReceiveHN">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="text-blue-800 font-semibold">Trung bình/ngày</h4>
                        <p class="text-2xl font-bold text-blue-600" id="avgDailyHN">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h4 class="text-purple-800 font-semibold">Ngày cao nhất</h4>
                        <p class="text-lg font-bold text-purple-600" id="maxDayHN">-</p>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-lg">
                        <h4 class="text-orange-800 font-semibold">Tăng trưởng</h4>
                        <p class="text-2xl font-bold text-orange-600" id="growthHN">0%</p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold mb-4">Biểu đồ xu hướng hàng nhận</h4>
                    <div class="h-96">
                        <canvas id="chartHN"></canvas>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-4">Chi tiết hàng nhận</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ngày
                                        nhận</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số lượng
                                        nhận</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">So với
                                        hôm trước</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tỷ lệ
                                        thay đổi (%)</th>
                                </tr>
                            </thead>
                            <tbody id="tableHN" class="divide-y divide-gray-200">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Báo cáo Hàng Giao -->
        <div id="hanggiao" class="report-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-shipping-fast text-orange-600 mr-3"></i>
                        Tổng Hợp Số Lượng Hàng Giao
                    </h2>
                </div>

                <!-- Filters -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Bộ lọc dữ liệu</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                            <input type="date" id="dateFromHG" onchange="applyFilterHG()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                            <input type="date" id="dateToHG" onchange="applyFilterHG()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loại thống kê</label>
                            <select id="periodHG" onchange="applyFilterHG()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="daily">Theo ngày</option>
                                <option value="weekly">Theo tuần</option>
                                <option value="monthly">Theo tháng</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="resetFilterHG()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-undo mr-2"></i>Đặt lại
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-orange-100 p-4 rounded-lg">
                        <h4 class="text-orange-800 font-semibold">Tổng hàng giao</h4>
                        <p class="text-2xl font-bold text-orange-600" id="totalDeliveryHG">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="text-blue-800 font-semibold">Trung bình/ngày</h4>
                        <p class="text-2xl font-bold text-blue-600" id="avgDailyHG">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h4 class="text-purple-800 font-semibold">Ngày cao nhất</h4>
                        <p class="text-lg font-bold text-purple-600" id="maxDayHG">-</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="text-green-800 font-semibold">Tăng trưởng</h4>
                        <p class="text-2xl font-bold text-green-600" id="growthHG">0%</p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold mb-4">Biểu đồ xu hướng hàng giao</h4>
                    <div class="h-96">
                        <canvas id="chartHG"></canvas>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-4">Chi tiết hàng giao</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ngày
                                        giao</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số lượng
                                        giao</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">So với
                                        hôm trước</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tỷ lệ
                                        thay đổi (%)</th>
                                </tr>
                            </thead>
                            <tbody id="tableHG" class="divide-y divide-gray-200">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl">
            <div class="flex items-center space-x-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-lg font-medium">Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Thông báo</span>
        </div>
    </div>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        // Constants for AppSheet connection
        const appId = '684ad0ab-ffc5-4c21-a959-f5e023c668e3';
        const accessKey = 'V2-jOfc3-JvKqz-lxeNm-FS8O6-1RK08-Bu5SX-erQVj-Jp2S9';
        const region = 'www';

        // Chart instances
        let charts = {};

        // Global data storage - Lưu trữ toàn bộ dữ liệu
        let globalData = {
            data3DMain: [],
            data3DDetail: [],
            dataTamDung: [],
            dataProduction: [],
            dataError: [],
            dataPolishing: [],
            dataReceive: [],
            dataDelivery: [],
            isLoaded: false
        };

        // Function to fetch data from AppSheet
        async function fetchAppSheetData(tableName) {
            try {
                const requestBody = {
                    "Action": "Find",
                    "Properties": {},
                    "Rows": []
                };

                console.log('Calling API:', tableName);

                const response = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log(`API Response for ${tableName}:`, data.length, 'records');

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                return data;
            } catch (error) {
                console.error(`Failed to fetch data from ${tableName}:`, error);
                return [];
            }
        }

        // Load all data at once
        async function loadAllData() {
            if (globalData.isLoaded) {
                console.log('Data already loaded, using cached data');
                return;
            }

            try {
                showLoading(true);
                showToast('Đang tải toàn bộ dữ liệu...', 'warning');

                // Load all tables in parallel
                const [
                    data3DMain,
                    data3DDetail,
                    dataTamDung,
                    dataProduction,
                    dataError,
                    dataPolishing,
                    dataReceive,
                    dataDelivery
                ] = await Promise.all([
                    fetchAppSheetData('trien_khai_3d_laze'),
                    fetchAppSheetData('trien_khai_3d_laze_dt'),
                    fetchAppSheetData('tam_dung'),
                    fetchAppSheetData('ke_hoach_pkt_dt'),
                    fetchAppSheetData('tong_hop_loi'),
                    fetchAppSheetData('hoan_thien_danh_bong_dt'),
                    fetchAppSheetData('so_giao_nhan'),
                    fetchAppSheetData('giao_kho_vp')
                ]);

                // Store in global data
                globalData.data3DMain = data3DMain;
                globalData.data3DDetail = data3DDetail;
                globalData.dataTamDung = dataTamDung;
                globalData.dataProduction = dataProduction;
                globalData.dataError = dataError;
                globalData.dataPolishing = dataPolishing;
                globalData.dataReceive = dataReceive;
                globalData.dataDelivery = dataDelivery;
                globalData.isLoaded = true;

                console.log('All data loaded:', {
                    '3D Main': data3DMain.length,
                    '3D Detail': data3DDetail.length,
                    'Tam Dung': dataTamDung.length,
                    'Production': dataProduction.length,
                    'Error': dataError.length,
                    'Polishing': dataPolishing.length,
                    'Receive': dataReceive.length,
                    'Delivery': dataDelivery.length
                });

                // Populate all dropdowns with real data
                populateAllDropdowns();

                showToast('Tải dữ liệu thành công!', 'success');

            } catch (error) {
                console.error('Error loading all data:', error);
                showToast('Lỗi khi tải dữ liệu: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function populateTeamDropdown() {
            const select = document.getElementById('teamSL');
            if (!select) return;

            const allTeams = new Set();
            globalData.dataProduction.forEach(item => {
                if (item.to) {
                    const teamValue = item.to.toString();
                    if (teamValue.includes(',')) {
                        teamValue.split(',').forEach(team => {
                            allTeams.add(team.trim());
                        });
                    } else {
                        allTeams.add(teamValue);
                    }
                }
            });

            select.innerHTML = '<option value="">Tất cả tổ</option>';

            // Sắp xếp và hiển thị các tổ với tên thân thiện
            const sortedTeams = Array.from(allTeams).sort();
            sortedTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;

                // Hiển thị tên thân thiện
                if (team === '0') {
                    option.textContent = 'Tổ Hành chính';
                } else if (team === '1/3') {
                    option.textContent = 'Tổ 1';
                } else if (team === '2/3') {
                    option.textContent = 'Tổ 2';
                } else if (team === '3/3') {
                    option.textContent = 'Tổ 3';
                } else {
                    option.textContent = `Tổ ${team}`;
                }

                select.appendChild(option);
            });
        }

        function populateErrorPositionDropdown() {
            const select = document.getElementById('positionLoi');
            if (!select) return;

            // Các vị trí cố định
            const positions = ['Phôi', 'PKY', 'PSX', 'PKT'];

            select.innerHTML = '<option value="">Tất cả vị trí</option>';
            positions.forEach(position => {
                const option = document.createElement('option');
                option.value = position;
                option.textContent = position;
                select.appendChild(option);
            });
        }

        // Populate all dropdowns with real data
        function populateAllDropdowns() {
            // 3D Machine dropdowns
            const machines = [...new Set(globalData.data3DMain.map(item => item.so_may).filter(Boolean))];
            populateDropdown('machine3d', machines, 'Tất cả máy');

            // Production dropdowns
            const groups = [...new Set(globalData.dataProduction.map(item => item.nhom).filter(Boolean))];
            populateDropdown('groupSL', groups, 'Tất cả nhóm');
            populateTeamDropdown(); // Sử dụng hàm riêng cho tổ

            // Error position dropdown - sử dụng hàm riêng với 4 vị trí cố định
            populateErrorPositionDropdown();
        }

        // Helper function to populate dropdown
        function populateDropdown(elementId, options, defaultText) {
            const select = document.getElementById(elementId);
            if (!select) return;

            select.innerHTML = `<option value="">${defaultText}</option>`;
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Refresh all data
        async function refreshAllData() {
            globalData.isLoaded = false;
            await loadAllData();

            // Refresh current report
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const reportId = activeTab.getAttribute('onclick').match(/'(.+)'/)[1];
                loadReportData(reportId);
            }
        }

        // Show/Hide loading
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;

            // Remove existing classes
            toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');

            // Add appropriate class based on type
            if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else if (type === 'warning') {
                toast.classList.add('bg-yellow-500');
            } else {
                toast.classList.add('bg-green-500');
            }

            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Show specific report
        function showReport(reportId) {
            // Hide all reports
            document.querySelectorAll('.report-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600', 'active');
            });

            // Show selected report
            document.getElementById(reportId).classList.remove('hidden');

            // Add active class to clicked tab
            event.target.classList.add('border-blue-500', 'text-blue-600', 'active');

            // Load data for the selected report
            loadReportData(reportId);
        }

        // Load data for specific report (using cached data)
        async function loadReportData(reportId) {
            if (!globalData.isLoaded) {
                await loadAllData();
            }

            switch (reportId) {
                case 'may3d':
                    load3DReport();
                    break;
                case 'sanluong':
                    loadProductionReport();
                    break;
                case 'loi':
                    loadErrorReport();
                    break;
                case 'danhbong':
                    loadPolishingReport();
                    break;
                case 'hangnhan':
                    loadReceiveReport();
                    break;
                case 'hanggiao':
                    loadDeliveryReport();
                    break;
            }
        }

        // Filter data based on criteria
        function filterData(data, filters) {
            return data.filter(item => {
                // Date filter
                if (filters.dateFrom && filters.dateTo && item[filters.dateField]) {
                    const itemDate = new Date(item[filters.dateField]).toISOString().split('T')[0];
                    if (itemDate < filters.dateFrom || itemDate > filters.dateTo) {
                        return false;
                    }
                }

                // Other filters
                for (const [field, value] of Object.entries(filters)) {
                    if (field.startsWith('date') || !value) continue;

                    if (field === 'position' && filters.position) {
                        if (!item.noi_phat_sinh_loi || !item.noi_phat_sinh_loi.includes(value)) {
                            return false;
                        }
                    } else if (item[field] !== undefined && item[field] != value) {
                        return false;
                    }
                }

                return true;
            });
        }

        // ========== 3D MACHINE REPORT ==========
        function load3DReport() {
            const filters = {
                dateFrom: document.getElementById('dateFrom3d').value,
                dateTo: document.getElementById('dateTo3d').value,
                dateField: 'ngay_tao',
                so_may: document.getElementById('machine3d').value,
                ca_lam_viec: document.getElementById('shift3d').value
            };

            // Map detail data with main data
            const mappedDetails = [];
            globalData.data3DDetail.forEach(detail => {
                const mainRecord = globalData.data3DMain.find(main => main.id === detail.id_trien_khai_3d_laze_dt);
                if (mainRecord) {
                    mappedDetails.push({
                        ...detail,
                        mainId: mainRecord.id,
                        ngay_tao: mainRecord.ngay_tao,
                        so_may: mainRecord.so_may,
                        ca_lam_viec: mainRecord.ca_lam_viec
                    });
                }
            });

            // Filter data
            const filteredData3D = filterData(mappedDetails, filters);

            // Get corresponding tam_dung data
            const mainIds = filteredData3D.map(item => item.mainId);
            const filteredTamDung = globalData.dataTamDung.filter(item =>
                mainIds.includes(item.id_trien_khai_3d_laze)
            );

            // Process and update display
            const processedData = process3DData(filteredData3D, filteredTamDung);
            update3DSummary(processedData);
            update3DChart(processedData);
            update3DTable(processedData);
        }

        function process3DData(data3D, dataTamDung) {
            const allMachines = [...new Set(data3D.map(item => item.so_may).filter(Boolean))];
            const machines = allMachines.length > 0 ? allMachines : ['3D AUTO2', '3D CƠ', '3D AUTO3'];

            const processedData = {
                machines: machines,
                chuanBi: [],
                chayThu: [],
                giaCong: [],
                gaLap: [],
                tamDung: [],
                tableData: [],
                summary: {
                    totalTime: 0,
                    workingTime: 0,
                    downTime: 0,
                    efficiency: 0
                }
            };

            machines.forEach(machine => {
                const machineData = data3D.filter(item => item.so_may === machine);
                const mainIds = machineData.map(item => item.mainId);
                const downTimeData = dataTamDung.filter(item =>
                    mainIds.includes(item.id_trien_khai_3d_laze)
                );

                let totalTime = 0;
                let chuanBiTime = 0;
                let chayThuTime = 0;
                let giaCongTime = 0;
                let gaLapTime = 0;
                let tamDungTime = 0;

                // Calculate times from detail data
                machineData.forEach(item => {
                    const cb = parseFloat(item.thoi_gian_chuan_bi || 0);
                    const ct = parseFloat(item.thoi_gian_chay_thu || 0);
                    const gc = parseFloat(item.thoi_gian_gia_cong || 0);
                    const gl = parseFloat(item.tong_thoi_gian_ga_lap || 0);

                    chuanBiTime += cb;
                    chayThuTime += ct;
                    giaCongTime += gc;
                    gaLapTime += gl;
                    totalTime += cb + ct + gc + gl;
                });

                // Calculate downtime
                downTimeData.forEach(item => {
                    const tdTime = parseFloat(item.thoi_gian_dung || 0);
                    tamDungTime += tdTime;
                    totalTime += tdTime;
                });

                // Convert to percentages
                if (totalTime > 0) {
                    processedData.chuanBi.push(Math.round((chuanBiTime / totalTime) * 100));
                    processedData.chayThu.push(Math.round((chayThuTime / totalTime) * 100));
                    processedData.giaCong.push(Math.round((giaCongTime / totalTime) * 100));
                    processedData.gaLap.push(Math.round((gaLapTime / totalTime) * 100));
                    processedData.tamDung.push(Math.round((tamDungTime / totalTime) * 100));
                } else {
                    processedData.chuanBi.push(0);
                    processedData.chayThu.push(0);
                    processedData.giaCong.push(0);
                    processedData.gaLap.push(0);
                    processedData.tamDung.push(0);
                }

                // Add to table data
                processedData.tableData.push({
                    machine: machine,
                    shift: 'Tất cả',
                    chuanBi: totalTime > 0 ? Math.round((chuanBiTime / totalTime) * 100) : 0,
                    chayThu: totalTime > 0 ? Math.round((chayThuTime / totalTime) * 100) : 0,
                    giaCong: totalTime > 0 ? Math.round((giaCongTime / totalTime) * 100) : 0,
                    gaLap: totalTime > 0 ? Math.round((gaLapTime / totalTime) * 100) : 0,
                    tamDung: totalTime > 0 ? Math.round((tamDungTime / totalTime) * 100) : 0
                });

                // Update summary
                processedData.summary.totalTime += totalTime;
                processedData.summary.workingTime += giaCongTime;
                processedData.summary.downTime += tamDungTime;
            });

            // Calculate efficiency
            if (processedData.summary.totalTime > 0) {
                processedData.summary.efficiency = Math.round((processedData.summary.workingTime / processedData.summary.totalTime) * 100);
            }

            return processedData;
        }

        function update3DSummary(data) {
            document.getElementById('totalTime3d').textContent = Math.round(data.summary.totalTime) + 'h';
            document.getElementById('workingTime3d').textContent = Math.round(data.summary.workingTime) + 'h';
            document.getElementById('downTime3d').textContent = Math.round(data.summary.downTime) + 'h';
            document.getElementById('efficiency3d').textContent = data.summary.efficiency + '%';
        }

        function update3DChart(data) {
            if (charts.chart3d) {
                charts.chart3d.destroy();
            }

            const ctx = document.getElementById('chart3d').getContext('2d');
            charts.chart3d = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.machines,
                    datasets: [
                        {
                            label: 'Chuẩn bị',
                            data: data.chuanBi,
                            backgroundColor: '#ef4444',
                            borderWidth: 1
                        },
                        {
                            label: 'Chạy thử',
                            data: data.chayThu,
                            backgroundColor: '#f97316',
                            borderWidth: 1
                        },
                        {
                            label: 'Gia công',
                            data: data.giaCong,
                            backgroundColor: '#22c55e',
                            borderWidth: 1
                        },
                        {
                            label: 'Gá lắp',
                            data: data.gaLap,
                            backgroundColor: '#3b82f6',
                            borderWidth: 1
                        },
                        {
                            label: 'Tạm dừng',
                            data: data.tamDung,
                            backgroundColor: '#6b7280',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            max: 100,
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function update3DTable(data) {
            const tbody = document.getElementById('table3d');
            tbody.innerHTML = '';

            data.tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.machine}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.shift}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.chuanBi}%</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.chayThu}%</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.giaCong}%</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.gaLap}%</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.tamDung}%</td>
               `;
                tbody.appendChild(tr);
            });
        }

        // ========== PRODUCTION REPORT ==========
        function loadProductionReport() {
            const filters = {
                dateFrom: document.getElementById('dateFromSL').value,
                dateTo: document.getElementById('dateToSL').value,
                dateField: 'ngay_tao',
                nhom: document.getElementById('groupSL').value,
                to: document.getElementById('teamSL').value
            };

            const filteredData = filterData(globalData.dataProduction, filters);
            const processedData = processProductionData(filteredData);

            updateProductionSummary(processedData);
            updateProductionChart(processedData);
            updateProductionPieChart(processedData);
            updateProductionTable(processedData);
        }

        function processProductionData(data) {
            // Lọc dữ liệu theo nhóm và tổ được chọn
            const selectedGroup = document.getElementById('groupSL').value;
            const selectedTeam = document.getElementById('teamSL').value;

            let filteredData = data;
            if (selectedGroup) {
                filteredData = filteredData.filter(item => item.nhom === selectedGroup);
            }
            if (selectedTeam) {
                filteredData = filteredData.filter(item => {
                    const teamValue = item.to ? item.to.toString() : '';
                    return teamValue === selectedTeam;
                });
            }

            // Nếu chọn cụ thể 1 nhóm và 1 tổ, hiển thị chi tiết theo tổ
            // Nếu không, hiển thị tổng hợp theo nhóm
            const groupByTeam = selectedGroup && selectedTeam;

            let groups;
            if (groupByTeam) {
                // Hiển thị chi tiết các tổ trong nhóm được chọn
                const teamsInGroup = [...new Set(filteredData.map(item => item.to).filter(Boolean))];
                groups = teamsInGroup;
            } else if (selectedGroup) {
                // Hiển thị tất cả tổ trong nhóm được chọn
                const teamsInGroup = [...new Set(filteredData.map(item => item.to).filter(Boolean))];
                groups = teamsInGroup.length > 0 ? teamsInGroup : [selectedGroup];
            } else {
                // Hiển thị theo nhóm
                groups = [...new Set(filteredData.map(item => item.nhom).filter(Boolean))];
            }

            const processedData = {
                labels: [],
                actual: [],
                theoretical: [],
                pieData: [],
                tableData: [],
                summary: {
                    totalProduction: 0,
                    avgEfficiency: 0,
                    totalWorkers: 0
                }
            };

            groups.forEach(group => {
                let groupData;
                let displayLabel;

                if (groupByTeam || selectedGroup) {
                    // Lọc theo tổ
                    groupData = filteredData.filter(item => item.to === group);
                    displayLabel = `Tổ ${formatTeamName(group)}`;
                } else {
                    // Lọc theo nhóm
                    groupData = filteredData.filter(item => item.nhom === group);
                    displayLabel = group;
                }

                let actualTime = 0;
                let theoreticalTime = 0;
                let production = 0;
                let workers = 0;

                groupData.forEach(item => {
                    const itemActualTime = parseFloat(item.Thoi_Gian_Thuc_Te || 0);
                    const itemTheoreticalTime = parseFloat(item.hoan_thanh_dk || 0);
                    const itemProduction = parseInt(item.sl_thuc_te || 0);
                    const itemWorkers = parseInt(item.so_nguoi_lam || 0);

                    // Xử lý trường hợp có nhiều tổ (ví dụ: "1/3, 2/3")
                    const teamValue = item.to ? item.to.toString() : '';
                    if (teamValue.includes(',')) {
                        // Chia đều cho các tổ
                        const teams = teamValue.split(',').map(t => t.trim());
                        const teamCount = teams.length;
                        actualTime += itemActualTime / teamCount;
                        theoreticalTime += itemTheoreticalTime / teamCount;
                        production += itemProduction / teamCount;
                        workers += itemWorkers / teamCount;
                    } else {
                        actualTime += itemActualTime;
                        theoreticalTime += itemTheoreticalTime;
                        production += itemProduction;
                        workers += itemWorkers;
                    }
                });

                const efficiency = theoreticalTime > 0 && actualTime > 0 ?
                    Math.round((theoreticalTime / actualTime) * 100) : 0;

                processedData.labels.push(displayLabel);
                processedData.actual.push(actualTime);
                processedData.theoretical.push(theoreticalTime);
                processedData.pieData.push(Math.round(production));

                processedData.tableData.push({
                    group: selectedGroup || (groupByTeam ? selectedGroup : group),
                    team: groupByTeam || selectedGroup ? formatTeamName(group) : 'Tất cả',
                    maCV: groupData.length > 0 ? (groupData[0].ma_cv || '-') : '-',
                    production: Math.round(production),
                    actualTime: actualTime,
                    theoreticalTime: theoreticalTime,
                    efficiency: efficiency
                });

                processedData.summary.totalProduction += Math.round(production);
                processedData.summary.totalWorkers += Math.round(workers);
            });

            const totalEfficiency = processedData.tableData.reduce((sum, item) => sum + item.efficiency, 0);
            processedData.summary.avgEfficiency = groups.length > 0 ? Math.round(totalEfficiency / groups.length) : 0;

            return processedData;
        }

        // Hàm helper để format tên tổ
        function formatTeamName(teamValue) {
            if (!teamValue) return 'Không xác định';

            const teamStr = teamValue.toString();

            if (teamStr === '0') return 'Hành chính';
            if (teamStr === '1/3') return '1';
            if (teamStr === '2/3') return '2';
            if (teamStr === '3/3') return '3';
            if (teamStr.includes('/')) {
                // Trường hợp có nhiều tổ như "1/3, 2/3"
                return teamStr.split(',').map(t => {
                    const clean = t.trim();
                    if (clean === '1/3') return '1';
                    if (clean === '2/3') return '2';
                    if (clean === '3/3') return '3';
                    return clean;
                }).join(', ');
            }

            return teamStr;
        }

        function updateProductionSummary(data) {
            document.getElementById('totalProductionSL').textContent = data.summary.totalProduction.toLocaleString();
            document.getElementById('avgEfficiencySL').textContent = data.summary.avgEfficiency + '%';
            document.getElementById('totalWorkersSL').textContent = data.summary.totalWorkers;
        }

        function updateProductionChart(data) {
            if (charts.chartSL) {
                charts.chartSL.destroy();
            }

            const ctx = document.getElementById('chartSL').getContext('2d');
            charts.chartSL = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Thời gian thực tế (h)',
                            data: data.actual,
                            backgroundColor: '#ef4444',
                            borderWidth: 1
                        },
                        {
                            label: 'Thời gian lý thuyết (h)',
                            data: data.theoretical,
                            backgroundColor: '#22c55e',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value + 'h';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateProductionPieChart(data) {
            if (charts.chartSLPie) {
                charts.chartSLPie.destroy();
            }

            const ctx = document.getElementById('chartSLPie').getContext('2d');
            charts.chartSLPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.pieData,
                        backgroundColor: [
                            '#ef4444',
                            '#f97316',
                            '#22c55e',
                            '#3b82f6',
                            '#8b5cf6'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                    return context.label + ': ' + context.raw.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateProductionTable(data) {
            const tbody = document.getElementById('tableSL');
            tbody.innerHTML = '';

            data.tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                const efficiencyClass = row.efficiency >= 100 ? 'text-green-600' :
                    row.efficiency >= 80 ? 'text-yellow-600' : 'text-red-600';

                tr.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.group}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.team}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.maCV}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.production.toLocaleString()}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.actualTime.toFixed(1)}h</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.theoreticalTime.toFixed(1)}h</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${efficiencyClass}">${row.efficiency}%</td>
               `;
                tbody.appendChild(tr);
            });
        }

        // ========== ERROR REPORT ==========
        function loadErrorReport() {
            const filters = {
                dateFrom: document.getElementById('dateFromLoi').value,
                dateTo: document.getElementById('dateToLoi').value,
                dateField: 'ngay_bao_loi',
                position: document.getElementById('positionLoi').value
            };

            const filteredData = filterData(globalData.dataError, filters);
            const processedData = processErrorData(filteredData);

            updateErrorSummary(processedData);
            updateErrorPieChart(processedData);
            updateErrorLineChart(processedData);
            updateErrorTable(processedData);
        }

        function processErrorData(data) {
            // Định nghĩa 4 vị trí cụ thể cần thống kê
            const predefinedPositions = ['Phôi', 'PKY', 'PSX', 'PKT'];

            const processedData = {
                pieLabels: predefinedPositions,
                pieData: [],
                lineLabels: [],
                lineData: [],
                tableData: [],
                summary: {
                    totalErrors: data.length,
                    todayErrors: 0,
                    topPosition: '',
                    avgErrorRate: 0
                }
            };

            // Đếm lỗi theo từng vị trí (tách chuỗi nếu có nhiều vị trí)
            const positionCounts = {
                'Phôi': 0,
                'PKY': 0,
                'PSX': 0,
                'PKT': 0
            };

            data.forEach(item => {
                if (item.noi_phat_sinh_loi) {
                    const positions = item.noi_phat_sinh_loi.toString().split(',').map(p => p.trim());
                    positions.forEach(pos => {
                        // Kiểm tra từng vị trí có chứa trong chuỗi không
                        if (pos.includes('Phôi')) positionCounts['Phôi']++;
                        else if (pos.includes('PKY')) positionCounts['PKY']++;
                        else if (pos.includes('PSX')) positionCounts['PSX']++;
                        else if (pos.includes('PKT')) positionCounts['PKT']++;
                    });
                }
            });

            // Chuẩn bị dữ liệu cho pie chart
            predefinedPositions.forEach(pos => {
                processedData.pieData.push(positionCounts[pos]);
            });

            // Tìm vị trí có nhiều lỗi nhất
            const maxErrors = Math.max(...Object.values(positionCounts));
            processedData.summary.topPosition = Object.keys(positionCounts).find(key => positionCounts[key] === maxErrors) || '-';

            // Đếm lỗi hôm nay
            const today = new Date().toISOString().split('T')[0];
            processedData.summary.todayErrors = data.filter(item =>
                item.ngay_bao_loi && item.ngay_bao_loi.toString().includes(today)
            ).length;

            // Nhóm lỗi theo ngày cho line chart
            const dateGroups = {};
            data.forEach(item => {
                const date = item.ngay_bao_loi ? item.ngay_bao_loi.toString().split('T')[0] : '';
                if (date) {
                    dateGroups[date] = (dateGroups[date] || 0) + 1;
                }
            });

            // Sắp xếp ngày và chuẩn bị dữ liệu line chart
            const sortedDates = Object.keys(dateGroups).sort();
            processedData.lineLabels = sortedDates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('vi-VN');
            });
            processedData.lineData = sortedDates.map(date => dateGroups[date]);

            // Đếm lỗi theo mã lỗi cho bảng
            const errorCounts = {};
            data.forEach(item => {
                const errorCode = item.ma_loi || 'Không xác định';
                if (!errorCounts[errorCode]) {
                    errorCounts[errorCode] = {
                        count: 0,
                        positions: new Set(),
                        handlers: new Set()
                    };
                }
                errorCounts[errorCode].count++;

                // Xử lý vị trí phát sinh (tách chuỗi nếu có nhiều vị trí)
                if (item.noi_phat_sinh_loi) {
                    const positions = item.noi_phat_sinh_loi.toString().split(',').map(p => p.trim());
                    positions.forEach(pos => {
                        errorCounts[errorCode].positions.add(pos);
                    });
                }

                // Xử lý nơi xử lý lỗi
                if (item.noi_xu_ly_loi) {
                    const handlers = item.noi_xu_ly_loi.toString().split(',').map(h => h.trim());
                    handlers.forEach(handler => {
                        errorCounts[errorCode].handlers.add(handler);
                    });
                }
            });

            // Chuyển đổi thành dữ liệu bảng và sắp xếp theo số lượng
            processedData.tableData = Object.entries(errorCounts)
                .map(([code, info]) => ({
                    errorCode: code,
                    count: info.count,
                    positions: Array.from(info.positions).join(', '),
                    handlers: Array.from(info.handlers).join(', '),
                    percentage: data.length > 0 ? Math.round((info.count / data.length) * 100) : 0
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10)
                .map((item, index) => ({
                    ...item,
                    rank: index + 1
                }));

            // Tính tỷ lệ lỗi trung bình
            processedData.summary.avgErrorRate = data.length > 0 ?
                Math.round((data.length / Math.max(sortedDates.length, 1)) * 10) / 10 : 0;

            return processedData;
        }

        function updateErrorSummary(data) {
            document.getElementById('totalErrorsLoi').textContent = data.summary.totalErrors.toLocaleString();
            document.getElementById('todayErrorsLoi').textContent = data.summary.todayErrors.toLocaleString();
            document.getElementById('topErrorPositionLoi').textContent = data.summary.topPosition;
            document.getElementById('avgErrorRateLoi').textContent = data.summary.avgErrorRate + '%';
        }

        function updateErrorPieChart(data) {
            if (charts.chartLoiPie) {
                charts.chartLoiPie.destroy();
            }

            const ctx = document.getElementById('chartLoiPie').getContext('2d');
            charts.chartLoiPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.pieLabels,
                    datasets: [{
                        data: data.pieData,
                        backgroundColor: [
                            '#ef4444',  // Phôi - Đỏ
                            '#f97316',  // PKY - Cam
                            '#22c55e',  // PSX - Xanh lá
                            '#3b82f6'   // PKT - Xanh dương
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                    return context.label + ': ' + context.raw + ' lỗi (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateErrorLineChart(data) {
            if (charts.chartLoiLine) {
                charts.chartLoiLine.destroy();
            }

            const ctx = document.getElementById('chartLoiLine').getContext('2d');
            charts.chartLoiLine = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.lineLabels,
                    datasets: [{
                        label: 'Số lượng lỗi',
                        data: data.lineData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateErrorTable(data) {
            const tbody = document.getElementById('tableLoi');
            tbody.innerHTML = '';

            data.tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                const percentageClass = row.percentage >= 20 ? 'text-red-600 font-bold' :
                    row.percentage >= 10 ? 'text-orange-600 font-medium' : 'text-gray-600';

                tr.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.rank}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.errorCode}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${row.count}</td>
                   <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${row.positions}</td>
                   <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${row.handlers}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm ${percentageClass}">${row.percentage}%</td>
               `;
                tbody.appendChild(tr);
            });
        }

        // ========== POLISHING REPORT ==========
        function loadPolishingReport() {
            const filters = {
                dateFrom: document.getElementById('dateFromDB').value,
                dateTo: document.getElementById('dateToDB').value,
                dateField: 'ngay_tao'
            };

            const filteredData = filterData(globalData.dataPolishing, filters);
            const processedData = processPolishingData(filteredData);

            updatePolishingSummary(processedData);
            updatePolishingChart(processedData);
            updatePolishingTable(processedData);
        }

        function processPolishingData(data) {
            const processedData = {
                labels: [],
                actualData: [],
                tableData: [],
                summary: {
                    totalProduction: 0,
                    avgTime: 0,
                    efficiency: 0
                }
            };

            // Group by date
            const dateGroups = {};
            data.forEach(item => {
                const date = item.ngay_tao ? item.ngay_tao.toString().split('T')[0] : '';
                if (!dateGroups[date]) {
                    dateGroups[date] = {
                        production: 0,
                        actualTime: 0,
                        items: []
                    };
                }
                dateGroups[date].production += parseInt(item.sl_thuc_te || 0);
                dateGroups[date].actualTime += parseFloat(item.Thoi_Gian_Thuc_Te || 0);
                dateGroups[date].items.push(item);
            });

            // Sort dates and prepare chart data
            const sortedDates = Object.keys(dateGroups).sort();
            processedData.labels = sortedDates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('vi-VN');
            });

            sortedDates.forEach(date => {
                const group = dateGroups[date];
                processedData.actualData.push(group.production);
            });

            // Prepare table data
            data.forEach(item => {
                const actualTime = parseFloat(item.Thoi_Gian_Thuc_Te || 0);
                const plannedTime = parseFloat(item.hoan_thanh_dk || 0);
                const efficiency = plannedTime > 0 && actualTime > 0 ?
                    Math.round((plannedTime / actualTime) * 100) : 0;

                processedData.tableData.push({
                    date: item.ngay_tao ? new Date(item.ngay_tao).toLocaleDateString('vi-VN') : '-',
                    maCV: item.ma_cv || '-',
                    tenChiTiet: item.ten_chi_tiet || '-',
                    production: parseInt(item.sl_thuc_te || 0),
                    actualTime: actualTime,
                    efficiency: efficiency
                });
            });

            // Calculate summary
            processedData.summary.totalProduction = data.reduce((sum, item) => sum + parseInt(item.sl_thuc_te || 0), 0);
            processedData.summary.avgTime = data.length > 0 ?
                data.reduce((sum, item) => sum + parseFloat(item.Thoi_Gian_Thuc_Te || 0), 0) / data.length : 0;

            const totalEfficiency = processedData.tableData.reduce((sum, item) => sum + item.efficiency, 0);
            processedData.summary.efficiency = processedData.tableData.length > 0 ?
                Math.round(totalEfficiency / processedData.tableData.length) : 0;

            return processedData;
        }

        function updatePolishingSummary(data) {
            document.getElementById('totalProductionDB').textContent = data.summary.totalProduction.toLocaleString();
            document.getElementById('avgTimeDB').textContent = data.summary.avgTime.toFixed(1) + 'h';
            document.getElementById('efficiencyDB').textContent = data.summary.efficiency + '%';
        }

        function updatePolishingChart(data) {
            if (charts.chartDB) {
                charts.chartDB.destroy();
            }

            const ctx = document.getElementById('chartDB').getContext('2d');
            charts.chartDB = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Sản lượng thực tế',
                            data: data.actualData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updatePolishingTable(data) {
            const tbody = document.getElementById('tableDB');
            tbody.innerHTML = '';

            data.tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                const efficiencyClass = row.efficiency >= 100 ? 'text-green-600' :
                    row.efficiency >= 80 ? 'text-yellow-600' : 'text-red-600';

                tr.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.date}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.maCV}</td>
                   <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${row.tenChiTiet}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.production.toLocaleString()}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.actualTime.toFixed(1)}h</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${efficiencyClass}">${row.efficiency}%</td>
               `;
                tbody.appendChild(tr);
            });
        }

        // ========== RECEIVE REPORT ==========
        function loadReceiveReport() {
            const filters = {
                dateFrom: document.getElementById('dateFromHN').value,
                dateTo: document.getElementById('dateToHN').value,
                dateField: 'ngay_nhan'
            };

            const period = document.getElementById('periodHN').value;
            const filteredData = filterData(globalData.dataReceive, filters);
            const processedData = processReceiveData(filteredData, period);

            updateReceiveSummary(processedData);
            updateReceiveChart(processedData);
            updateReceiveTable(processedData);
        }

        function processReceiveData(data, period) {
            const processedData = {
                labels: [],
                receiveData: [],
                tableData: [],
                summary: {
                    totalReceive: 0,
                    avgDaily: 0,
                    maxDay: '',
                    growth: 0
                }
            };

            // Group data by period
            const groups = {};
            data.forEach(item => {
                const date = item.ngay_nhan ? item.ngay_nhan.toString().split('T')[0] : '';
                let groupKey = date;

                if (period === 'weekly') {
                    const d = new Date(date);
                    const weekStart = new Date(d.setDate(d.getDate() - d.getDay()));
                    groupKey = weekStart.toISOString().split('T')[0];
                } else if (period === 'monthly') {
                    groupKey = date.substring(0, 7); // YYYY-MM
                }

                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        quantity: 0,
                        date: date
                    };
                }
                groups[groupKey].quantity += parseInt(item.sl_nhan || 0);
            });

            // Sort and prepare chart data
            const sortedKeys = Object.keys(groups).sort();
            processedData.labels = sortedKeys.map(key => {
                if (period === 'weekly') {
                    const d = new Date(key);
                    return `Tuần ${Math.ceil((d.getDate()) / 7)} - ${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                } else if (period === 'monthly') {
                    const [year, month] = key.split('-');
                    return `${month}/${year}`;
                } else {
                    const d = new Date(key);
                    return d.toLocaleDateString('vi-VN');
                }
            });

            processedData.receiveData = sortedKeys.map(key => groups[key].quantity);

            // Prepare table data
            const dailyData = {};
            data.forEach(item => {
                const date = item.ngay_nhan ? item.ngay_nhan.toString().split('T')[0] : '';
                if (!dailyData[date]) {
                    dailyData[date] = 0;
                }
                dailyData[date] += parseInt(item.sl_nhan || 0);
            });

            const sortedDates = Object.keys(dailyData).sort();
            processedData.tableData = sortedDates.map((date, index) => {
                const prevDate = index > 0 ? sortedDates[index - 1] : null;
                const prevQuantity = prevDate ? dailyData[prevDate] : 0;
                const quantity = dailyData[date];
                const change = quantity - prevQuantity;
                const changePercent = prevQuantity > 0 ? Math.round((change / prevQuantity) * 100) : 0;

                return {
                    date: new Date(date).toLocaleDateString('vi-VN'),
                    quantity: quantity,
                    change: change,
                    changePercent: changePercent
                };
            });

            // Calculate summary
            processedData.summary.totalReceive = Object.values(dailyData).reduce((sum, qty) => sum + qty, 0);
            processedData.summary.avgDaily = sortedDates.length > 0 ?
                Math.round(processedData.summary.totalReceive / sortedDates.length) : 0;

            // Find max day
            const maxQuantity = Math.max(...Object.values(dailyData));
            const maxDate = Object.keys(dailyData).find(date => dailyData[date] === maxQuantity);
            processedData.summary.maxDay = maxDate ? new Date(maxDate).toLocaleDateString('vi-VN') : '-';

            // Calculate growth (compare first and last period)
            if (processedData.receiveData.length >= 2) {
                const firstPeriod = processedData.receiveData[0];
                const lastPeriod = processedData.receiveData[processedData.receiveData.length - 1];
                processedData.summary.growth = firstPeriod > 0 ?
                    Math.round(((lastPeriod - firstPeriod) / firstPeriod) * 100) : 0;
            }

            return processedData;
        }

        function updateReceiveSummary(data) {
            document.getElementById('totalReceiveHN').textContent = data.summary.totalReceive.toLocaleString();
            document.getElementById('avgDailyHN').textContent = data.summary.avgDaily.toLocaleString();
            document.getElementById('maxDayHN').textContent = data.summary.maxDay;

            const growthElement = document.getElementById('growthHN');
            growthElement.textContent = (data.summary.growth >= 0 ? '+' : '') + data.summary.growth + '%';
            growthElement.className = data.summary.growth >= 0 ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
        }

        function updateReceiveChart(data) {
            if (charts.chartHN) {
                charts.chartHN.destroy();
            }

            const ctx = document.getElementById('chartHN').getContext('2d');
            charts.chartHN = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Số lượng hàng nhận',
                        data: data.receiveData,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#22c55e',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.raw.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateReceiveTable(data) {
            const tbody = document.getElementById('tableHN');
            tbody.innerHTML = '';

            data.tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                const changeClass = row.change > 0 ? 'text-green-600' :
                    row.change < 0 ? 'text-red-600' : 'text-gray-500';
                const changeIcon = row.change > 0 ? '↗' : row.change < 0 ? '↘' : '→';

                tr.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.date}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.quantity.toLocaleString()}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm ${changeClass}">${changeIcon} ${Math.abs(row.change).toLocaleString()}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${changeClass}">${row.changePercent}%</td>
               `;
                tbody.appendChild(tr);
            });
        }

        // ========== DELIVERY REPORT ==========
        function loadDeliveryReport() {
            const filters = {
                dateFrom: document.getElementById('dateFromHG').value,
                dateTo: document.getElementById('dateToHG').value,
                dateField: 'ngay_dong_goi'
            };

            const period = document.getElementById('periodHG').value;
            const filteredData = filterData(globalData.dataDelivery, filters);
            const processedData = processDeliveryData(filteredData, period);

            updateDeliverySummary(processedData);
            updateDeliveryChart(processedData);
            updateDeliveryTable(processedData);
        }

        function processDeliveryData(data, period) {
            const processedData = {
                labels: [],
                deliveryData: [],
                tableData: [],
                summary: {
                    totalDelivery: 0,
                    avgDaily: 0,
                    maxDay: '',
                    growth: 0
                }
            };

            // Group data by period
            const groups = {};
            data.forEach(item => {
                const date = item.ngay_dong_goi ? item.ngay_dong_goi.toString().split('T')[0] : '';
                let groupKey = date;

                if (period === 'weekly') {
                    const d = new Date(date);
                    const weekStart = new Date(d.setDate(d.getDate() - d.getDay()));
                    groupKey = weekStart.toISOString().split('T')[0];
                } else if (period === 'monthly') {
                    groupKey = date.substring(0, 7); // YYYY-MM
                }

                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        quantity: 0,
                        date: date
                    };
                }
                groups[groupKey].quantity += parseInt(item.sll || 0);
            });

            // Sort and prepare chart data
            const sortedKeys = Object.keys(groups).sort();
            processedData.labels = sortedKeys.map(key => {
                if (period === 'weekly') {
                    const d = new Date(key);
                    return `Tuần ${Math.ceil((d.getDate()) / 7)} - ${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                } else if (period === 'monthly') {
                    const [year, month] = key.split('-');
                    return `${month}/${year}`;
                } else {
                    const d = new Date(key);
                    return d.toLocaleDateString('vi-VN');
                }
            });

            processedData.deliveryData = sortedKeys.map(key => groups[key].quantity);

            // Prepare table data
            const dailyData = {};
            data.forEach(item => {
                const date = item.ngay_dong_goi ? item.ngay_dong_goi.toString().split('T')[0] : '';
                if (!dailyData[date]) {
                    dailyData[date] = 0;
                }
                dailyData[date] += parseInt(item.sll || 0);
            });

            const sortedDates = Object.keys(dailyData).sort();
            processedData.tableData = sortedDates.map((date, index) => {
                const prevDate = index > 0 ? sortedDates[index - 1] : null;
                const prevQuantity = prevDate ? dailyData[prevDate] : 0;
                const quantity = dailyData[date];
                const change = quantity - prevQuantity;
                const changePercent = prevQuantity > 0 ? Math.round((change / prevQuantity) * 100) : 0;

                return {
                    date: new Date(date).toLocaleDateString('vi-VN'),
                    quantity: quantity,
                    change: change,
                    changePercent: changePercent
                };
            });

            // Calculate summary
            processedData.summary.totalDelivery = Object.values(dailyData).reduce((sum, qty) => sum + qty, 0);
            processedData.summary.avgDaily = sortedDates.length > 0 ?
                Math.round(processedData.summary.totalDelivery / sortedDates.length) : 0;

            // Find max day
            const maxQuantity = Math.max(...Object.values(dailyData));
            const maxDate = Object.keys(dailyData).find(date => dailyData[date] === maxQuantity);
            processedData.summary.maxDay = maxDate ? new Date(maxDate).toLocaleDateString('vi-VN') : '-';

            // Calculate growth (compare first and last period)
            if (processedData.deliveryData.length >= 2) {
                const firstPeriod = processedData.deliveryData[0];
                const lastPeriod = processedData.deliveryData[processedData.deliveryData.length - 1];
                processedData.summary.growth = firstPeriod > 0 ?
                    Math.round(((lastPeriod - firstPeriod) / firstPeriod) * 100) : 0;
            }

            return processedData;
        }

        function updateDeliverySummary(data) {
            document.getElementById('totalDeliveryHG').textContent = data.summary.totalDelivery.toLocaleString();
            document.getElementById('avgDailyHG').textContent = data.summary.avgDaily.toLocaleString();
            document.getElementById('maxDayHG').textContent = data.summary.maxDay;

            const growthElement = document.getElementById('growthHG');
            growthElement.textContent = (data.summary.growth >= 0 ? '+' : '') + data.summary.growth + '%';
            growthElement.className = data.summary.growth >= 0 ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
        }

        function updateDeliveryChart(data) {
            if (charts.chartHG) {
                charts.chartHG.destroy();
            }

            const ctx = document.getElementById('chartHG').getContext('2d');
            charts.chartHG = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Số lượng hàng giao',
                        data: data.deliveryData,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#f97316',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.raw.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDeliveryTable(data) {
            const tbody = document.getElementById('tableHG');
            tbody.innerHTML = '';

            data.tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                const changeClass = row.change > 0 ? 'text-green-600' :
                    row.change < 0 ? 'text-red-600' : 'text-gray-500';
                const changeIcon = row.change > 0 ? '↗' : row.change < 0 ? '↘' : '→';

                tr.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.date}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.quantity.toLocaleString()}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm ${changeClass}">${changeIcon} ${Math.abs(row.change).toLocaleString()}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${changeClass}">${row.changePercent}%</td>
               `;
                tbody.appendChild(tr);
            });
        }

        // ========== FILTER FUNCTIONS ==========
        function applyFilter3D() {
            load3DReport();
        }

        function resetFilter3D() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom3d').value = today;
            document.getElementById('dateTo3d').value = today;
            document.getElementById('machine3d').value = '';
            document.getElementById('shift3d').value = '';
            load3DReport();
        }

        function applyFilterSL() {
            loadProductionReport();
        }

        function resetFilterSL() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFromSL').value = today;
            document.getElementById('dateToSL').value = today;
            document.getElementById('groupSL').value = '';
            document.getElementById('teamSL').value = '';
            loadProductionReport();
        }

        function applyFilterLoi() {
            loadErrorReport();
        }

        function resetFilterLoi() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('dateFromLoi').value = weekAgo;
            document.getElementById('dateToLoi').value = today;
            document.getElementById('positionLoi').value = '';
            loadErrorReport();
        }

        function applyFilterDB() {
            loadPolishingReport();
        }

        function resetFilterDB() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('dateFromDB').value = weekAgo;
            document.getElementById('dateToDB').value = today;
            loadPolishingReport();
        }

        function applyFilterHN() {
            loadReceiveReport();
        }

        function resetFilterHN() {
            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('dateFromHN').value = monthAgo;
            document.getElementById('dateToHN').value = today;
            document.getElementById('periodHN').value = 'daily';
            loadReceiveReport();
        }

        function applyFilterHG() {
            loadDeliveryReport();
        }

        function resetFilterHG() {
            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('dateFromHG').value = monthAgo;
            document.getElementById('dateToHG').value = today;
            document.getElementById('periodHG').value = 'daily';
            loadDeliveryReport();
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async function () {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // Set dates for all reports
            document.getElementById('dateFrom3d').value = today;
            document.getElementById('dateTo3d').value = today;

            document.getElementById('dateFromSL').value = today;
            document.getElementById('dateToSL').value = today;

            document.getElementById('dateFromLoi').value = weekAgo;
            document.getElementById('dateToLoi').value = today;

            document.getElementById('dateFromDB').value = weekAgo;
            document.getElementById('dateToDB').value = today;

            document.getElementById('dateFromHN').value = monthAgo;
            document.getElementById('dateToHN').value = today;

            document.getElementById('dateFromHG').value = monthAgo;
            document.getElementById('dateToHG').value = today;

            // Load all data once at startup
            await loadAllData();

            // Show first report by default
            load3DReport();

            // Welcome message
            showToast('Hệ thống đã sẵn sàng! Tất cả dữ liệu đã được tải.');
        });

        // Export functions (optional)
        window.exportToExcel = function (reportType) {
            showToast('Chức năng xuất Excel đang được phát triển', 'warning');
        };

        window.exportToPDF = function (reportType) {
            showToast('Chức năng xuất PDF đang được phát triển', 'warning');
        };

        window.printReport = function () {
            window.print();
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey) {
                switch (e.key) {
                    case '1':
                        e.preventDefault();
                        document.querySelector('[onclick*="may3d"]').click();
                        break;
                    case '2':
                        e.preventDefault();
                        document.querySelector('[onclick*="sanluong"]').click();
                        break;
                    case '3':
                        e.preventDefault();
                        document.querySelector('[onclick*="loi"]').click();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshAllData();
                        break;
                }
            }
        });

        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };

        // Auto-refresh every 10 minutes (less frequent since we load all data)
        setInterval(function () {
            refreshAllData();
            showToast('Dữ liệu đã được tự động làm mới', 'warning');
        }, 600000); // 10 minutes

    </script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Hide scrollbar but keep functionality */
        .scrollbar-hide {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari and Opera */
        }

        /* Smooth scrolling for tabs */
        nav {
            scroll-behavior: smooth;
        }

        /* Optional: Add scroll indicators */
        @media (max-width: 1024px) {
            .container.mx-auto {
                position: relative;
            }

            .container.mx-auto::after {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                width: 20px;
                height: 100%;
                background: linear-gradient(to left, rgba(255, 255, 255, 0.8), transparent);
                pointer-events: none;
            }
        }

        /* Ensure tabs don't shrink */
        .tab-btn {
            min-width: fit-content;
        }

        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }

            .report-section {
                page-break-inside: avoid;
            }

            .bg-white {
                background: white !important;
            }
        }

        /* Animation for loading */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Responsive table */
        @media (max-width: 768px) {
            .overflow-x-auto table {
                font-size: 12px;
            }

            .overflow-x-auto th,
            .overflow-x-auto td {
                padding: 8px 12px;
            }
        }

        /* Chart container responsive */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        /* Tab active indicator */
        .tab-btn.active {
            position: relative;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }

        /* Loading overlay improvement */
        #loading {
            backdrop-filter: blur(4px);
        }

        /* Filter section enhancement */
        .bg-gray-50 {
            border-left: 4px solid #3b82f6;
        }

        /* Summary cards hover effect */
        .bg-blue-100:hover,
        .bg-green-100:hover,
        .bg-red-100:hover,
        .bg-yellow-100:hover,
        .bg-purple-100:hover,
        .bg-orange-100:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
    </style>
</body>

</html>